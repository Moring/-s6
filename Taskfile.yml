version: '3'

env:
  ENV_FILE: .env

dotenv: ['.env']

tasks:
  # === Main Tasks ===
  
  up:
    desc: Start all services (backend + frontend)
    cmds:
      - task: network
      - docker compose -f backend/docker-compose.yml --env-file .env up -d
      - docker compose -f frontend/docker-compose.yml --env-file .env up -d
      - task: wait-for-backend
      - task: status

  down:
    desc: Stop all services
    cmds:
      - docker compose -f frontend/docker-compose.yml down
      - docker compose -f backend/docker-compose.yml down

  restart:
    desc: Restart all services
    cmds:
      - task: down
      - task: up

  reset:
    desc: Reset everything (stop, remove volumes, start)
    cmds:
      - task: down
      - docker compose -f frontend/docker-compose.yml down -v
      - docker compose -f backend/docker-compose.yml down -v
      - docker network rm afterresume-net || true
      - task: up

  # === Logs ===
  
  logs:
    desc: Tail all service logs
    cmds:
      - docker compose -f backend/docker-compose.yml logs -f

  logs-frontend:
    desc: Tail frontend logs
    cmds:
      - docker compose -f frontend/docker-compose.yml logs -f

  logs-backend:
    desc: Tail backend logs
    cmds:
      - docker compose -f backend/docker-compose.yml logs -f backend-api

  logs-worker:
    desc: Tail worker logs
    cmds:
      - docker compose -f backend/docker-compose.yml logs -f backend-worker

  # === Database ===
  
  migrate:
    desc: Run database migrations
    cmds:
      - docker compose -f backend/docker-compose.yml exec backend-api python manage.py migrate

  django-migrate:
    desc: Run Django migrations locally inside the backend folder
    cmds:
      - cd backend && python manage.py migrate

  makemigrations:
    desc: Create new migrations
    cmds:
      - docker compose -f backend/docker-compose.yml exec backend-api python manage.py makemigrations

  dbshell:
    desc: Open database shell
    cmds:
      - docker compose -f backend/docker-compose.yml exec postgres psql -U afterresume -d afterresume

  # === Shell Access ===
  
  bash-backend:
    desc: Open bash in backend container
    cmds:
      - docker compose -f backend/docker-compose.yml exec backend-api bash

  bash-frontend:
    desc: Open bash in frontend container
    cmds:
      - docker compose -f frontend/docker-compose.yml exec frontend bash

  # === Status & Health ===
  
  status:
    desc: Show status of all services
    cmds:
      - echo "=== Backend Services ==="
      - docker compose -f backend/docker-compose.yml ps
      - echo ""
      - echo "=== Frontend Services ==="
      - docker compose -f frontend/docker-compose.yml ps

  health:
    desc: Check health of all services
    cmds:
      - 'echo "=== Checking Backend Health ==="'
      - 'curl -s http://localhost:8000/api/healthz/ | jq . || echo "Backend not responding"'
      - 'echo ""'
      - 'echo "=== Checking Frontend Health ==="'
      - 'curl -s http://localhost:3000/healthz || echo "Frontend not responding"'

  # === Development ===
  
  seed:
    desc: Seed demo data
    cmds:
      - docker compose -f backend/docker-compose.yml exec backend-api python scripts/seed_demo_data.py

  create-admin:
    desc: Create admin user
    cmds:
      - docker compose -f backend/docker-compose.yml exec backend-api python scripts/create_admin.py

  bootstrap:
    desc: Bootstrap the system (migrate + seed)
    cmds:
      - task: migrate
      - task: seed
      - 'echo "Bootstrap complete! Frontend: http://localhost:3000"'

  'dev:up':
    desc: Start backend in dev config and run frontend dev server locally
    cmds:
      - task: network
      - DJANGO_SETTINGS_MODULE=config.settings.dev DEBUG=1 docker compose -f backend/docker-compose.yml --env-file .env up -d
      - task: wait-for-backend


  # === Testing ===
  
  test-backend:
    desc: Run backend tests
    cmds:
      - docker compose -f backend/docker-compose.yml exec backend-api pytest --create-db

  test-frontend:
    desc: Run frontend tests
    cmds:
      - docker compose -f frontend/docker-compose.yml exec frontend pytest

  # === Utility ===
  
  network:
    desc: Create Docker network
    cmds:
      - docker network create afterresume-net || true
    silent: true

  wait-for-backend:
    desc: Wait for backend to be healthy
    cmds:
      - |
        echo "Waiting for backend to be healthy..."
        for i in {1..30}; do
          if curl -s "http://localhost:8000/api/healthz/" > /dev/null 2>&1; then
            echo "Backend is healthy!"
            break
          fi
          echo "Attempt $i/30: Backend not ready yet..."
          sleep 2
        done

  clean:
    desc: Clean up Docker resources
    cmds:
      - docker system prune -f

  ps:
    desc: Show all running containers
    cmds:
      - docker ps --filter "name=afterresume"

  'deploy:registry':
    desc: Deploy registry to WireGuard host and tail logs
    cmds:
      - rsync -az --info=progress2 ./docker-compose.registry.yml root@10.6.0.2:/root/docker-compose.registry.yml
      - ssh root@10.6.0.2 "printf '%s\n' 'REGISTRY_USER=digimuse_registry' 'REGISTRY_PASSWORD=yeQc1seF7D4tQbspkz1vamjGSQLer8ZHkb77gnv' > /root/.env && chmod 600 /root/.env"
      - ssh -t root@10.6.0.2 "cd /root && docker compose -f docker-compose.registry.yml --env-file .env up -d && docker compose -f docker-compose.registry.yml logs -f registry"

  'deploy:frontend':
    desc: Deploy frontend to WireGuard host and tail logs
    cmds:
      - rsync -az --delete --info=progress2 --exclude 'traefik/' ./endpoint/ root@cassini.appliedautonomics.com:/root/endpoint/
      - ssh root@cassini.appliedautonomics.com "mkdir -p /root/endpoint/traefik && [ -f /root/endpoint/traefik/acme.json ] || printf '%s\n' '{}' > /root/endpoint/traefik/acme.json && chmod 600 /root/endpoint/traefik/acme.json"
      - ssh root@cassini.appliedautonomics.com "echo 'Checking connectivity to backend http://turing.appliedautonomics.com:8000' && curl -sS --max-time 5 http://turing.appliedautonomics.com:8000/v2/ || echo 'Backend not reachable from frontend host'"
      - ssh -t root@cassini.appliedautonomics.com "cd /root/endpoint && docker compose -f docker-compose.yml --env-file .env --profile traefik up --build -d && docker compose -f docker-compose.yml logs -f traefik"
  'deploy:backend':
    desc: Deploy backend to WireGuard host and tail logs
    cmds:
      - ssh davmor@turing.appliedautonomics.com "mkdir -p /home/davmor/dm/s6/backend"
      - ssh davmor@turing.appliedautonomics.com "cd /home/davmor/dm/s6/backend && git pull --recurse-submodules && git submodule update --init --recursive || true"
      - scp /home/davmor/dm/s6/.env davmor@turing.appliedautonomics.com:/home/davmor/dm/s6/.env
      - ssh davmor@turing.appliedautonomics.com "docker network inspect afterresume-net >/dev/null 2>&1 || docker network create afterresume-net"
      - ssh -t davmor@turing.appliedautonomics.com "cd /home/davmor/dm/s6/backend && DJANGO_SETTINGS_MODULE=config.settings.prod docker compose -f docker-compose.yml --env-file /home/davmor/dm/s6/.env up --build -d && docker compose -f docker-compose.yml logs -f backend-api"