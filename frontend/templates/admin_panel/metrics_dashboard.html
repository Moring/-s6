{% extends "base_shell.html" %}
{% load static %}

{% block title %}Executive Metrics - Admin - AfterResume{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="page-title-box d-flex justify-content-between align-items-center">
            <div>
                <h4 class="page-title">Executive Dashboard</h4>
                <p class="text-muted mb-0">Key business metrics and system health indicators</p>
            </div>
            <div>
                <span class="text-muted me-3">
                    <i class="ti ti-clock me-1"></i>
                    Last updated: <span id="last-updated">{{ last_updated|default:"Never" }}</span>
                </span>
                <button type="button" class="btn btn-outline-primary" 
                        hx-get="{% url 'admin_panel:metrics_dashboard' %}" 
                        hx-target="body" 
                        hx-swap="outerHTML">
                    <i class="ti ti-refresh me-1"></i> Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Key Metrics Grid -->
<div class="row mb-4">
    <!-- MRR -->
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                        <h6 class="text-muted mb-1">MRR</h6>
                        <h3 class="mb-0">${{ metrics.mrr|default:"0"|floatformat:0 }}</h3>
                    </div>
                    <div class="avatar-sm">
                        <span class="avatar-title rounded bg-success-subtle text-success fs-18">
                            <i class="ti ti-trending-up"></i>
                        </span>
                    </div>
                </div>
                <div class="text-muted fs-13">
                    ARR: ${{ metrics.arr|default:"0"|floatformat:0 }}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Active Users -->
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                        <h6 class="text-muted mb-1">Active Users</h6>
                        <h3 class="mb-0">{{ metrics.dau|default:"0" }}</h3>
                    </div>
                    <div class="avatar-sm">
                        <span class="avatar-title rounded bg-primary-subtle text-primary fs-18">
                            <i class="ti ti-users"></i>
                        </span>
                    </div>
                </div>
                <div class="text-muted fs-13">
                    DAU | WAU: {{ metrics.wau|default:"0" }} | MAU: {{ metrics.mau|default:"0" }}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Churn Rate -->
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                        <h6 class="text-muted mb-1">Churn Rate</h6>
                        <h3 class="mb-0">{{ metrics.churn_rate|default:"0"|floatformat:1 }}%</h3>
                    </div>
                    <div class="avatar-sm">
                        <span class="avatar-title rounded bg-warning-subtle text-warning fs-18">
                            <i class="ti ti-user-off"></i>
                        </span>
                    </div>
                </div>
                <div class="text-muted fs-13">
                    {{ metrics.churned_customers|default:"0" }} churned this month
                </div>
            </div>
        </div>
    </div>
    
    <!-- System Health -->
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                        <h6 class="text-muted mb-1">System Health</h6>
                        <h3 class="mb-0">
                            {% if metrics.health_score >= 95 %}
                                <span class="text-success">{{ metrics.health_score|default:"—" }}%</span>
                            {% elif metrics.health_score >= 80 %}
                                <span class="text-warning">{{ metrics.health_score|default:"—" }}%</span>
                            {% else %}
                                <span class="text-danger">{{ metrics.health_score|default:"—" }}%</span>
                            {% endif %}
                        </h3>
                    </div>
                    <div class="avatar-sm">
                        <span class="avatar-title rounded bg-info-subtle text-info fs-18">
                            <i class="ti ti-heartbeat"></i>
                        </span>
                    </div>
                </div>
                <div class="text-muted fs-13">
                    {{ metrics.failed_jobs|default:"0" }} failed jobs today
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Second Row Metrics -->
<div class="row mb-4">
    <!-- New Customers -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h6 class="text-muted mb-3">New Customers (30d)</h6>
                <h4 class="mb-2">{{ metrics.new_customers|default:"0" }}</h4>
                <div class="progress" style="height: 6px;">
                    <div class="progress-bar bg-success" role="progressbar" 
                         style="width: {{ metrics.growth_percentage|default:0 }}%;"></div>
                </div>
                <small class="text-muted">{{ metrics.growth_percentage|default:"0"|floatformat:1 }}% growth</small>
            </div>
        </div>
    </div>
    
    <!-- ARPA -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h6 class="text-muted mb-3">ARPA</h6>
                <h4 class="mb-2">${{ metrics.arpa|default:"0"|floatformat:2 }}</h4>
                <small class="text-muted">Average Revenue Per Account</small>
            </div>
        </div>
    </div>
    
    <!-- Conversion Rate -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h6 class="text-muted mb-3">Trial → Paid Conversion</h6>
                <h4 class="mb-2">{{ metrics.conversion_rate|default:"0"|floatformat:1 }}%</h4>
                <small class="text-muted">{{ metrics.conversions|default:"0" }} conversions this month</small>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-3">MRR Trend (90 days)</h5>
                <div id="mrr-chart" style="height: 250px;">
                    <!-- Placeholder for chart -->
                    <div class="text-center py-5 text-muted">
                        <i class="ti ti-chart-line fs-64 mb-3"></i>
                        <p>Chart visualization coming soon</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-3">Active Users (30 days)</h5>
                <div id="dau-chart" style="height: 250px;">
                    <!-- Placeholder for chart -->
                    <div class="text-center py-5 text-muted">
                        <i class="ti ti-chart-bar fs-64 mb-3"></i>
                        <p>Chart visualization coming soon</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Operations Metrics -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-3">Operational Metrics</h5>
                
                <div class="row">
                    <div class="col-md-3">
                        <div class="mb-3">
                            <small class="text-muted d-block">API Avg Latency</small>
                            <h5 class="mb-0">{{ metrics.api_latency_ms|default:"—" }}ms</h5>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <small class="text-muted d-block">API Error Rate</small>
                            <h5 class="mb-0">{{ metrics.error_rate|default:"0"|floatformat:2 }}%</h5>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <small class="text-muted d-block">Job Queue Depth</small>
                            <h5 class="mb-0">{{ metrics.queue_depth|default:"0" }}</h5>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <small class="text-muted d-block">Jobs Run (24h)</small>
                            <h5 class="mb-0">{{ metrics.jobs_run_24h|default:"0" }}</h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AI/LLM Metrics -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-3">AI Usage Metrics</h5>
                
                <div class="row">
                    <div class="col-md-3">
                        <div class="mb-3">
                            <small class="text-muted d-block">Total LLM Calls (24h)</small>
                            <h5 class="mb-0">{{ metrics.llm_calls_24h|default:"0" }}</h5>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <small class="text-muted d-block">Avg Job Duration</small>
                            <h5 class="mb-0">{{ metrics.avg_job_duration|default:"—" }}s</h5>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <small class="text-muted d-block">Job Failure Rate</small>
                            <h5 class="mb-0">{{ metrics.job_failure_rate|default:"0"|floatformat:1 }}%</h5>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <small class="text-muted d-block">Token Cost (24h)</small>
                            <h5 class="mb-0">${{ metrics.token_cost_24h|default:"0"|floatformat:2 }}</h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Alerts & Thresholds -->
{% if alerts %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-warning">
            <div class="card-body">
                <h5 class="card-title text-warning mb-3">
                    <i class="ti ti-alert-triangle me-2"></i>Active Alerts
                </h5>
                <ul class="list-unstyled mb-0">
                    {% for alert in alerts %}
                    <li class="mb-2">
                        <i class="ti ti-point-filled text-warning"></i>
                        <strong>{{ alert.title }}:</strong> {{ alert.message }}
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Cohort Retention -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-3">Cohort Retention</h5>
                
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Cohort</th>
                                <th>Week 1</th>
                                <th>Week 4</th>
                                <th>Week 12</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cohort in metrics.cohorts|default_if_none:list %}
                            <tr>
                                <td>{{ cohort.name }}</td>
                                <td>{{ cohort.week_1|default:"—" }}%</td>
                                <td>{{ cohort.week_4|default:"—" }}%</td>
                                <td>{{ cohort.week_12|default:"—" }}%</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center text-muted py-3">
                                    No cohort data available yet
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Metric Definitions Link -->
<div class="row mt-3">
    <div class="col-12">
        <div class="alert alert-info">
            <i class="ti ti-info-circle me-2"></i>
            <strong>Metric Definitions:</strong> See <a href="#" class="alert-link">Admin Guide</a> for detailed metric definitions and calculation methods.
        </div>
    </div>
</div>

<script>
// Auto-refresh every 60 seconds
setInterval(function() {
    document.querySelector('[hx-get="{{ url('admin_panel:metrics_dashboard') }}"]').click();
}, 60000);
</script>

{% endblock %}
