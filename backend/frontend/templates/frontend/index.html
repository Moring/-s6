{% extends "frontend/base.html" %}
{% load static %}

{% block extra_css %}
<style>
    .chat-canvas-wrapper {
        display: flex;
        flex-direction: column;
        height: 100vh;
        background-color: #f8f9fa;
    }
    
    .main-content-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
    .chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        border-bottom: 2px solid #dee2e6;
        background: white;
        overflow: hidden;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
    }
    
    .chat-input-area {
        padding: 15px;
        border-top: 1px solid #dee2e6;
        background: #f8f9fa;
    }
    
    .canvas-area {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f1f3f5;
    }
    
    .message {
        margin-bottom: 15px;
        animation: fadeIn 0.3s;
    }
    
    .message-user {
        text-align: right;
    }
    
    .message-bot {
        text-align: left;
    }
    
    .message-content {
        display: inline-block;
        padding: 10px 15px;
        border-radius: 8px;
        max-width: 70%;
    }
    
    .message-user .message-content {
        background: #007bff;
        color: white;
    }
    
    .message-bot .message-content {
        background: #e9ecef;
        color: #212529;
    }
    
    .message-error .message-content {
        background: #dc3545;
        color: white;
    }
    
    .message-success .message-content {
        background: #28a745;
        color: white;
    }
    
    .password-stars {
        letter-spacing: 4px;
        font-family: monospace;
    }
    
    .working-indicator {
        display: inline-block;
        margin-left: 10px;
    }
    
    .working-indicator span {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #007bff;
        animation: bounce 1.4s infinite ease-in-out both;
    }
    
    .working-indicator span:nth-child(1) {
        animation-delay: -0.32s;
    }
    
    .working-indicator span:nth-child(2) {
        animation-delay: -0.16s;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes bounce {
        0%, 80%, 100% { 
            transform: scale(0);
        } 40% { 
            transform: scale(1.0);
        }
    }
    
    .status-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 20px;
        background: #343a40;
        color: white;
        font-size: 14px;
    }
    
    .status-item {
        margin: 0 15px;
    }
    
    .canvas-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .canvas-card-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 15px;
        color: #212529;
    }
    
    .stat-box {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 6px;
        margin-bottom: 10px;
    }
    
    .stat-label {
        font-weight: 500;
        color: #6c757d;
    }
    
    .stat-value {
        font-size: 24px;
        font-weight: 700;
        color: #007bff;
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-canvas-wrapper">
    <!-- Main Content: Chat + Canvas -->
    <div class="main-content-area">
        <!-- Top Panel: Chat -->
        <div class="chat-area">
            <div class="chat-messages" id="chat-messages">
                {% if not is_authenticated %}
                <div class="message message-bot">
                    <div class="message-content">
                        Welcome to AfterResume! ðŸ‘‹<br>
                        Ask a question, or type <strong>login</strong> or <strong>signup</strong>.
                    </div>
                </div>
                {% else %}
                <div class="message message-bot">
                    <div class="message-content">
                        Welcome back, {{ username }}! ðŸŽ‰<br>
                        Type <strong>help</strong> to see available commands.
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- Chat Input -->
            <div class="chat-input-area">
                <form id="chat-form" hx-post="{% url 'frontend:chat_send' %}" hx-target="#chat-messages" hx-swap="beforeend" hx-indicator="#working-indicator">
                    {% csrf_token %}
                    <div class="input-group">
                        <input type="text" 
                               name="message" 
                               id="chat-input" 
                               class="form-control" 
                               placeholder="Type your message... (Enter to send, Shift+Enter for new line)" 
                               autocomplete="off"
                               required>
                        <button class="btn btn-primary" type="submit">
                            Send
                        </button>
                        <div id="working-indicator" class="working-indicator htmx-indicator">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Bottom Panel: Canvas -->
        <div class="canvas-area" id="canvas-area">
            {% if not is_authenticated %}
                {% include 'frontend/partials/login_form_card.html' %}
            {% else %}
                <div class="canvas-card">
                    <div class="canvas-card-title">Canvas</div>
                    <p class="text-muted">Chat actions will display structured results here. Type <strong>dashboard</strong> to see your stats.</p>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Footer: Status Bar -->
    <div class="status-bar" 
         hx-get="{% url 'frontend:status_bar' %}" 
         hx-trigger="every 5s" 
         hx-swap="innerHTML">
        <div class="status-left">
            <span class="status-item">Session Tokens: <strong id="token-count">0</strong></span>
        </div>
        <div class="status-right">
            <span class="status-item">Reserve Balance: <strong id="reserve-balance">$0.00</strong></span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Handle Enter vs Shift+Enter
    document.getElementById('chat-input').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            document.getElementById('chat-form').dispatchEvent(new Event('submit', {bubbles: true}));
        }
    });
    
    // Clear input after successful send
    document.body.addEventListener('htmx:afterRequest', function(e) {
        if (e.detail.elt.id === 'chat-form' && e.detail.successful) {
            document.getElementById('chat-input').value = '';
        }
    });
    
    // Auto-scroll chat to bottom
    document.body.addEventListener('htmx:afterSwap', function(e) {
        if (e.detail.target.id === 'chat-messages') {
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    });
    
    // Handle canvas triggers
    document.body.addEventListener('htmx:afterSettle', function(e) {
        const triggerCanvas = e.detail.elt.dataset.triggerCanvas;
        if (triggerCanvas) {
            if (triggerCanvas === 'dashboard') {
                htmx.ajax('GET', '{% url "frontend:dashboard_card" %}', '#canvas-area');
            }
        }
        
        // Handle page reload
        const reloadPage = e.detail.elt.dataset.reloadPage;
        if (reloadPage === 'true') {
            setTimeout(() => location.reload(), 1000);
        }
    });
</script>
{% endblock %}
